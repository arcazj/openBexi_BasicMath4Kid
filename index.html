<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenBexi Math Playground â€“ 3-D Operations</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <script type="importmap">
        {
          "imports": {
            "three":         "https://unpkg.com/three@0.176.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.176.0/examples/jsm/"
          }
        }
    </script>

    <style>
        :root {
            --pink: #ff7aaa;
            --blue: #7ac4ff;
            --green: #7affc0;
            --yellow: #ffe67a;
            --navy: #0e1e35;
            --light: #ffffff;
            --shadow: 0 4px 10px rgba(0, 0, 0, .25);
            --btn-w: 4.2rem;
        }

        * {
            box-sizing: border-box;
            font-family: 'Comic Sans MS', system-ui, sans-serif;
        }

        body {
            margin: 0;
            background: var(--navy);
            color: var(--light);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            padding: .6rem 1rem;
            font-size: 1.6rem;
            text-align: center;
        }

        #app {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #controls {
            width: 340px;
            min-width: 280px;
            background: var(--pink);
            padding: 1rem;
            border-radius: 0 .9rem .9rem 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            box-shadow: var(--shadow);
            max-height: 100vh;
            overflow: auto;
            z-index: 10;
        }

        @media (max-width: 640px) {
            #app {
                flex-direction: column;
            }

            #controls {
                flex-direction: row;
                flex-wrap: wrap;
                width: 100%;
                border-radius: 0;
            }
        }

        .lang-row {
            display: flex;
            gap: .6rem;
        }

        .lang-btn {
            flex: 1;
            padding: .45rem;
            border: none;
            border-radius: .55rem;
            font-weight: bold;
            cursor: pointer;
            background: var(--green);
            color: var(--navy);
            box-shadow: var(--shadow);
            font-size: .9rem;
        }

        .lang-btn.active {
            filter: brightness(1.2);
        }

        .op-btn {
            width: 100%;
            padding: 1.1rem;
            border: none;
            border-radius: .75rem;
            font-size: 1.35rem;
            font-weight: bold;
            background: var(--blue);
            color: var(--navy);
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        .op-btn.active {
            filter: brightness(1.15);
        }

        #equation {
            background: #000;
            padding: .4rem;
            border-radius: .5rem;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            text-shadow: var(--shadow);
        }

        #answerPrompt {
            font-size: .97rem;
            text-align: center;
            margin-top: .25rem;
        }

        #keypad {
            display: grid;
            grid-template-columns:repeat(4, var(--btn-w));
            gap: .6rem;
            justify-content: center;
            margin-top: .2rem;
        }

        .key-btn {
            width: var(--btn-w);
            height: var(--btn-w);
            line-height: var(--btn-w);
            border: none;
            border-radius: .65rem;
            font-size: 1.15rem;
            font-weight: bold;
            background: var(--yellow);
            color: var(--navy);
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        .key-btn.correct {
            background: #10984d;
            color: #fff;
        }

        .key-btn.wrong {
            background: #d60709;
            color: #fff;
        }

        .key-btn:disabled {
            opacity: .75;
            cursor: not-allowed;
        }

        .key-btn.spacer {
            visibility: hidden;
            pointer-events: none;
        }

        #sceneContainer {
            flex: 1;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block
        }
    </style>
</head>

<body>
<header>ðŸ§® OpenBexi Math Playground</header>

<div id="app">
    <div id="controls">
        <div class="lang-row">
            <button class="lang-btn active" data-lang="en">English</button>
            <button class="lang-btn" data-lang="fr">FranÃ§ais</button>
            <button class="lang-btn" data-lang="es">EspaÃ±ol</button>
        </div>

        <button class="op-btn" data-op="add">Addition</button>
        <button class="op-btn" data-op="sub">Subtraction</button>
        <button class="op-btn" data-op="mul">Multiplication</button>
        <button class="op-btn" data-op="div">Division</button>

        <div id="equation">Pick an operation!</div>
        <div id="answerPrompt">Provide answer: Tap a number (0â€“18).</div>
        <div id="keypad"></div>
    </div>

    <div id="sceneContainer"></div>
</div>

<script type="module">
    /* â”€â”€â”€ imports â”€â”€â”€ */
    import * as THREE from 'three';
    import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
    import {RoomEnvironment} from 'three/addons/environments/RoomEnvironment.js';

    /* â”€â”€â”€ language strings â”€â”€â”€ */
    const TXT = {
        en: {
            add: 'Addition', sub: 'Subtraction', mul: 'Multiplication', div: 'Division',
            pick: 'Pick an operation!', correct: 'ðŸ˜Š', wrong: 'ðŸ˜•'
        },
        fr: {
            add: 'Addition', sub: 'Soustraction', mul: 'Multiplication', div: 'Division',
            pick: 'Choisissez une opÃ©ration !', correct: 'ðŸ˜Š', wrong: 'ðŸ˜•'
        },
        es: {
            add: 'Suma', sub: 'Resta', mul: 'MultiplicaciÃ³n', div: 'DivisiÃ³n',
            pick: 'Â¡Elige una operaciÃ³n !', correct: 'ðŸ˜Š', wrong: 'ðŸ˜•'
        }
    };
    let LANG = 'en';

    /* â”€â”€â”€ DOM refs â”€â”€â”€ */
    const eqn = document.getElementById('equation');
    const opBtns = [...document.querySelectorAll('.op-btn')];
    const langBtns = [...document.querySelectorAll('.lang-btn')];
    const keypad = document.getElementById('keypad');
    const controlsPane = document.getElementById('controls');

    /* â”€â”€â”€ keypad build â”€â”€â”€ */
    for (let n = 0; n <= 18; n++) {
        const k = document.createElement('button');
        k.className = 'key-btn';
        k.textContent = n;
        k.disabled = true;
        k.onclick = () => submitAnswer(n, k);
        keypad.appendChild(k);
    }
    keypad.appendChild(Object.assign(document.createElement('button'), {className: 'key-btn spacer'}));

    /* â”€â”€â”€ Three.js scene â”€â”€â”€ */
    const container = document.getElementById('sceneContainer');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0e1e35);
    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
    camera.position.set(6, 6, 6);

    const renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.25;
    renderer.physicallyCorrectLights = true;
    scene.environment = new THREE.PMREMGenerator(renderer).fromScene(new RoomEnvironment(), 0.04).texture;

    /* lights */
    const dir = new THREE.DirectionalLight(0xffffff, 1);
    dir.position.set(0, 10, 7);
    scene.add(dir);
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));
    const rim = new THREE.PointLight(0xffffff, 40, 50);
    rim.position.set(5, 5, -5);
    scene.add(rim);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enablePan = false;
    controls.enableDamping = true;
    controls.minDistance = 4;
    controls.maxDistance = 14;

    /* â”€â”€â”€ viewport padding â”€â”€â”€ */
    let pad = {x: 0, y: 0};

    function wuPerPx(dist) {
        const vF = THREE.MathUtils.degToRad(camera.fov);
        return (2 * dist * Math.tan(vF / 2)) / renderer.domElement.clientHeight;
    }

    function updatePad() {
        const wu = wuPerPx(camera.position.length());
        if (window.innerWidth > 640) {
            pad.x = controlsPane.offsetWidth * wu * 0.5;
            pad.y = 0;
        } else {
            pad.x = 0;
            pad.y = -controlsPane.offsetHeight * wu * 0.5;
        }
    }

    /* â”€â”€â”€ resize handler â”€â”€â”€ */
    function onResize() {
        const w = Math.floor(container.clientWidth),
            h = Math.floor(container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);           // crisp on zoom/rotation
        renderer.setSize(w, h, true);                                // buffer + css, no blur
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        updatePad();
    }

    window.addEventListener('resize', onResize);
    onResize();

    /* â”€â”€â”€ helpers â”€â”€â”€ */
    const rand = (a, b) => Math.floor(Math.random() * (b - a + 1)) + a;

    function cube(col) {
        return new THREE.Mesh(
            new THREE.BoxGeometry(.3, .8, .3),  // crisp, low poly
            new THREE.MeshPhysicalMaterial({
                color: col, metalness: 1, roughness: .05,
                envMapIntensity: 1.2, clearcoat: .3, clearcoatRoughness: .1
            }))
    }

    function row(g, n, x, z, c) {
        for (let i = 0; i < n; i++) {
            const m = cube(c);
            m.position.set(x + i/1.2, z, 0);
            g.add(m);
        }
    }

    /* â”€â”€â”€ state â”€â”€â”€ */
    let group = null, answerVal = null, ready = false, loop = null;
    const setLoop = f => loop = f;
    const newGroup = () => {
        const g = new THREE.Group();
        g.position.set(pad.x, pad.y, 0);
        scene.add(g);
        return g;
    }
    const clearScene = () => {
        if (group) {
            group.traverse(o => o.isMesh && (o.geometry.dispose(), o.material.dispose()));
            scene.remove(group);
        }
    };

    /* â”€â”€â”€ UI actions â”€â”€â”€ */
    langBtns.forEach(b => b.onclick = () => {
        LANG = b.dataset.lang;
        langBtns.forEach(l => l.classList.toggle('active', l === b));
        opBtns.forEach(o => o.textContent = TXT[LANG][o.dataset.op]);
        if (!ready) eqn.textContent = TXT[LANG].pick;
    });
    opBtns.forEach(o => o.onclick = () => {
        opBtns.forEach(b => b.classList.toggle('active', b === o));
        keypad.querySelectorAll('.key-btn').forEach(k => {
            k.disabled = true;
            k.classList.remove('correct', 'wrong');
        });
        ready = false;
        eqn.textContent = TXT[LANG][o.dataset.op] + 'â€¦';
        ({add: demoAdd, sub: demoSub, mul: demoMul, div: demoDiv}[o.dataset.op])();
    });

    /* answer */
    function submitAnswer(v, btn) {
        if (!ready) return;
        keypad.querySelectorAll('.key-btn').forEach(k => k.disabled = true);
        btn.classList.add(v === answerVal ? 'correct' : 'wrong');
        eqn.textContent = eqn.textContent.replace('?', answerVal) + ' ' + TXT[LANG][v === answerVal ? 'correct' : 'wrong'];
    }

    /* â”€â”€â”€ demos â”€â”€â”€ */
    function demoAdd() {
        let a, b;
        do {
            a = rand(0, 9);
            b = rand(0, 9);
        } while (a + b > 18);
        const sum = a + b, start = -(sum - 1) / 2;
        clearScene();
        group = newGroup();
        if (a) row(group, a, start, 1, 0x7ac4ff);
        if (b) row(group, b, start, -1, 0xff7aaa);
        eqn.textContent = `${a} + ${b} = ?`;
        answerVal = sum;
        let t = 0;
        setLoop(() => {
            if (t < 1) {
                t += .02;
                group.children.slice(a).forEach(m => m.position.z = -2.5 + 2.5 * t);
                if (t >= 1) {
                    ready = true;
                    keypad.querySelectorAll('.key-btn').forEach(k => k.disabled = false);
                }
            }
        });
    }

    function demoSub() {
        const a = rand(0, 9), b = rand(0, a), diff = a - b, start = -(a - 1) / 2;
        clearScene();
        group = newGroup();
        if (a) row(group, a, start, 0, 0x7affc0);
        eqn.textContent = `${a} âˆ’ ${b} = ?`;
        answerVal = diff;
        const rem = group.children.slice(-b);
        let blink = 0;
        setLoop(() => {
            blink += .09;
            rem.forEach(c => c.material.opacity = .5 + .5 * Math.sin(blink));
            if (blink > Math.PI * 2) {
                rem.forEach(c => group.remove(c));
                ready = true;
                keypad.querySelectorAll('.key-btn').forEach(k => k.disabled = false);
                setLoop(null);
            }
        });
    }

    function demoMul() {
        let a, b;
        do {
            a = rand(0, 9);
            b = rand(0, 9);
        } while (a * b > 18);
        const prod = a * b;
        clearScene();
        group = newGroup();
        for (let i = 0; i < a; i++) for (let j = 0; j < b; j++) {
            const m = cube(0xffe67a);
            m.position.set(j - (b - 1) / 2, 0, i - (a - 1) / 2);
            m.scale.set(0, 0, 0);
            group.add(m);
        }
        eqn.textContent = `${a} Ã— ${b} = ?`;
        answerVal = prod;
        let s = 0;
        setLoop(() => {
            if (s < 1) {
                s += .03;
                group.children.forEach(m => m.scale.set(s, s, s));
                if (s >= 1) {
                    ready = true;
                    keypad.querySelectorAll('.key-btn').forEach(k => k.disabled = false);
                }
            }
        });
    }

    function demoDiv() {
        let parts, each, total;
        do {
            parts = rand(1, 9);
            each = rand(1, 9);
            total = parts * each;
        } while (total > 18);
        clearScene();
        group = newGroup();
        row(group, total, -(total - 1) / 2, 1, 0x7ac4ff);
        eqn.textContent = `${total} Ã· ${parts} = ?`;
        answerVal = each;
        let t = 0, phase = 0;
        setLoop(() => {
            if (phase === 0 && (t += .02) >= 1) {
                phase = 1;
                t = 0;
            } else if (phase === 1) {
                group.children.forEach((m, i) => {
                    const g = Math.floor(i / each);
                    m.position.z = THREE.MathUtils.lerp(0, (g % 2 ? 1 : -1) * 2, t);
                });
                if ((t += .02) >= 1) {
                    ready = true;
                    keypad.querySelectorAll('.key-btn').forEach(k => k.disabled = false);
                    setLoop(null);
                }
            }
        });
    }

    /* â”€â”€â”€ render â”€â”€â”€ */
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        loop && loop();
        renderer.render(scene, camera);
    }

    animate();
</script>
</body>
</html>
